# 剪贴板历史工具功能开发文档（适配当前项目）

## 1. 文档目的

本文档用于指导 `clipboard-history` 的功能开发落地，基于现有代码结构给出可执行的实现方案、接口定义、数据结构、阶段计划与验收标准。

## 2. 当前项目基线（必须先统一认知）

### 2.1 事实基线

- 当前工程是 **Tauri 2 + Vue 3 + Vite**，不是 Electron。
- 目前代码仍是模板态，仅包含 `greet` 示例调用。

关键证据：

- `package.json`：`@tauri-apps/api`、`@tauri-apps/cli`
- `src-tauri/Cargo.toml`：`tauri = "2"`
- `src/App.vue`：默认欢迎页 + `invoke("greet")`
- `src-tauri/src/lib.rs`：仅 `#[tauri::command] fn greet(...)`
- `功能介绍.md`：描述了目标功能，但尚未在代码实现

### 2.2 开发原则

- 以 **Tauri 方案**落地，不回退到 Electron。
- 先做可用主链路（采集 -> 存储 -> 展示 -> 回填），再做增强功能（去重优化、快捷键、托盘、迁移）。
- 所有功能以“本地可验证”为准，不只写文档。

## 3. 目标功能范围（对应《功能介绍》）

### 3.1 必做功能（MVP）

1. 自动采集剪贴板内容（文本、图片）
2. 历史列表展示与筛选（全部/文本/图片/收藏）
3. 点击历史项回填复制
4. 收藏/取消收藏
5. 本地持久化（历史、设置、图片目录）

### 3.2 增强功能（V1）

1. 智能去重合并（文本精确、图片哈希）
2. 关键字搜索（文本）
3. 清空历史
4. 全局快捷键唤起窗口
5. 托盘常驻与显示/隐藏
6. 自定义存储目录与数据迁移

## 4. 建议技术设计（适配 Tauri）

### 4.1 模块分层

- 前端（Vue）
  - 列表展示、筛选、搜索、收藏交互
  - 设置页（快捷键、开机自启、存储路径）
- 后端（Rust/Tauri Command）
  - 剪贴板采集与去重
  - 文件存储与迁移
  - 托盘/窗口控制/全局快捷键

### 4.2 数据存储约定

默认目录：Tauri `app_data_dir`（可切换到用户自定义目录）

- 历史：`clipboard-history.json`
- 设置：`settings.json`
- 图片：`clipboard-images/`

### 4.3 数据模型（建议）

```json
{
  "id": "uuid",
  "type": "text | image",
  "text": "...",
  "imagePath": "clipboard-images/xxx.png",
  "contentHash": "...",
  "isFavorite": false,
  "createdAt": 1739000000000,
  "updatedAt": 1739000000000,
  "source": "optional"
}
```

设置模型：

```json
{
  "globalShortcut": "Alt+Shift+V",
  "launchAtStartup": false,
  "storageDir": "",
  "pollIntervalMs": 500
}
```

## 5. 智能去重合并设计

### 5.1 文本去重

- 规则：文本内容标准化后（trim、换行统一）进行精确比较。
- 命中重复：不上新条目，仅更新 `updatedAt`，并将记录上浮到顶部。

### 5.2 图片去重

- 首选：对原始图片字节计算哈希（建议 BLAKE3 或 SHA-256）。
- 命中重复：复用已有图片文件路径，仅更新记录时间并上浮。

### 5.3 冲突与安全策略

- 哈希命中后做一次字节级校验（避免极低概率碰撞误判）。
- 历史加载时执行一次“标准化 + 去重清洗”（兼容旧数据）。

## 6. Tauri 命令接口草案

建议后端对前端暴露以下命令：

1. `get_history(filter, keyword)`
2. `copy_history_item(id)`
3. `toggle_favorite(id)`
4. `clear_history()`
5. `get_settings()`
6. `update_settings(payload)`
7. `select_storage_dir()`
8. `migrate_storage(from, to)`
9. `set_window_visible(visible)`
10. `register_global_shortcut(accelerator)`

说明：

- 采集逻辑可放在 Rust 后台任务中（轮询间隔由设置控制）。
- 前端通过 `invoke` 调用命令，必要时用事件推送“新增历史项”。

## 7. 开发分期计划

### Phase 1：主链路打通（优先）

1. 定义历史与设置的数据模型
2. 完成本地 JSON 读写
3. 完成剪贴板采集（文本 + 图片）
4. 完成列表展示与点击回填

验收：可持续记录并复用历史内容。

### Phase 2：可用性增强

1. 收藏/取消收藏
2. 筛选与搜索
3. 清空历史
4. 去重合并与历史清洗

验收：重复内容不膨胀，检索体验可用。

### Phase 3：桌面集成能力

1. 全局快捷键唤起窗口
2. 托盘驻留与显示/隐藏
3. 设置项（开机自启、快捷键、目录切换）
4. 目录迁移（历史+图片）

验收：符合桌面常驻工具使用习惯。

## 8. Tauri v2 插件与权限建议

建议引入并配置：

1. `clipboard-manager`（读写剪贴板）
2. `global-shortcut`（全局快捷键）
3. `store`（设置与轻量持久化）
4. `tray-icon`（系统托盘）

能力配置需同步到 `src-tauri/capabilities/default.json`，按最小权限开放。

## 9. 验收标准（Definition of Done）

每项功能完成需满足：

1. 功能可在本机手动验证
2. 数据可重启后保留
3. 重复内容不会无限增长
4. 关键异常有可读错误提示（无静默失败）
5. 不破坏已有历史数据兼容

## 10. 风险与注意事项

1. 当前项目与《功能介绍》存在技术栈描述差异（Electron vs Tauri），后续文档统一按 Tauri。
2. 图片体积可能快速增大，需加入历史上限与清理策略（条数/空间上限）。
3. 全局快捷键在不同平台行为不一致，需按 Windows/macOS/Linux 分别验证。
4. 自定义目录迁移必须是“复制成功后切换 + 可回滚”。

## 11. 里程碑交付物

1. 可运行的 Tauri 剪贴板历史应用（替换模板页）
2. 稳定的数据目录与迁移机制
3. 对应用户文档（功能说明 + 设置说明 + 常见问题）

---

如果后续进入实现阶段，建议先按 Phase 1 落地，再逐步补齐 Phase 2/3，避免一次性大改导致联调复杂度过高。
